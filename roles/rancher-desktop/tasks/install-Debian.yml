---
# Debian/Ubuntu installation tasks for Rancher Desktop

- name: Check if Rancher Desktop is already installed
  stat:
    path: /usr/bin/rancher-desktop
  register: rancher_desktop_installed
  changed_when: false

- name: Display Rancher Desktop configuration
  ansible.builtin.debug:
    var: rancher_desktop
    verbosity: 0

- name: Get latest Rancher Desktop release info
  uri:
    url: "https://api.github.com/repos/{{ rancher_desktop.repo }}/releases?per_page={{ rancher_desktop.version }}"
    method: GET
    return_content: yes
    status_code: 200
  register: latest_release
  when: not rancher_desktop_installed.stat.exists
  retries: 3
  delay: 5
  until: latest_release is success

- name: Extract download URL for Linux deb
  set_fact:
    download_url: "{{ item.browser_download_url }}"
  loop: "{{ latest_release.json[0].assets }}"
  when:
    - not rancher_desktop_installed.stat.exists
    - item.name is match('.*amd64.deb$')
  register: download_url_result
  failed_when: (item | length) == 0

- name: Download Rancher Desktop deb package
  get_url:
    url: "{{ download_url }}"
    dest: /tmp/rancher-desktop.deb
  when:
    - not rancher_desktop_installed.stat.exists
  retries: 3
  delay: 5

- name: Install Rancher Desktop
  ansible.builtin.apt:
    deb: /tmp/rancher-desktop.deb
    state: present
  become: yes
  when: not rancher_desktop_installed.stat.exists

- name: Clean up downloaded deb
  file:
    path: /tmp/rancher-desktop.deb
    state: absent
  when: not rancher_desktop_installed.stat.exists
